<html>
	<head>
		<style type="text/css">
			body {
				font-family: sans-serif;
			}
			#allTypes {
				margin: 0;
				padding: 10px;
				overflow: auto;
			}

				#allTypes li {
					list-style: none;
					margin: 2px;
					display: inline-block;
					background: #ddd;
					border-radius: 3px 4px;
					padding: 2px 5px;
					font-size: xx-small;
					cursor: pointer;
				}

			#results {
				width: 400px;
				height: 590px;
				float: right;
				background: #ccc;
				border: solid 1px #ddd;
				padding: 5px;
				overflow: scroll;
			}

				#results .expected {
					font-weight: bold;
					color: #576AF1;
				}

				#results td,
				#results th {
					font-size: xx-small;
					text-align: left;
				}

				#results .heading {
					border-bottom: solid 1px #F17777;
					padding: 3px;
				}

				#results td.pass,
				#results td.fail {
					background: url(images/tick.png) no-repeat;
					width: 16px;
					height: 16px;
					padding: 0;
				}

				#results td.fail {
					background-position: 0 -16px;
				}

		</style>
	</head>
	<body>
		<script src="../build/three.js"></script>

		<!-- TypeLoader dependencies -->
		<script src="../examples/fonts/helvetiker_regular.typeface.js"></script>
		<script src="../examples/js/loaders/ColladaLoader.js"></script>
		
		<script src="list.js"></script>

		<script src="HelpDocParser.js"></script>
		<script src="TestHelpDocs.js"></script>
		<script src="node_indexer/tokenmap.js"></script>

		<script id="dyn"></script>

		<iframe id="hostFrame" name="hostFrame" style="width: 100%; height: 600px;"></iframe>

		<div id="results"></div>

		<ul id="allTypes"></ul>

		<script>

			var storageKey = 'helpDocs';
			var types = [];
			var helpDocs = {};
			var errors = [];
			var hostFrame = document.getElementById('hostFrame');

			var ul = document.getElementById('allTypes');
			ul.addEventListener('click', showClickedItem, false);

			loadDocuments();

			function compareTypes(instance, base) {

				var local = [];
				var remote = [];
				var overridden = [];

				for (var p in instance)
				{
					var baseVal = base[p];
					var instVal = instance[p];

					var baseType = typeof baseVal;
					var instType = typeof instVal;

					if (p in base) {
						if (baseType == 'function' && !equals(instVal, baseVal, instType, baseType))
							overridden.push(p);
						else
							remote.push(p);
					} else {
						local.push(p)
					}
				}

				return { local: local, remote: remote, overridden: overridden };

			}

			function equals(dis, dat, typeA, typeB) {

				if (typeA != typeB) return false;

				
				switch (typeA) {
					case 'object':
						if (Array.isArray(dis)) {
							return JSON.stringify(dis) == JSON.stringify(dat);
						} else {
							return dis === dat; break;
						}
					case 'function':
						return dis.toString() == dat.toString(); break;
					default:
						return dis == dat; break;
				}
			}

			function showClickedItem(e) {

				// Display the help docs
				hostFrame.src = e.srcElement.getAttribute('data-url');

				var className = e.srcElement.textContent;
				var helpDoc = helpDocs[className];
				var categorized;

				var elem = document.getElementById('results');
				elem.innerHTML = '';

				var tbl = document.createElement('table');
				
				var relatedFiles = tokenMap.tokenMap['THREE.' + className].map(function(i){ return tokenMap.files[i]});
				showDependants(tbl, relatedFiles);
				elem.appendChild(tbl);

				var instance = typeMap.getInstance(className);

				if (helpDoc.superName || helpDoc.protoName) {
					// Compare the instance against its proto to decipher inheritance
					categorized = compareTypes(instance, typeMap.getInstance(helpDoc.superName || helpDoc.protoName))
				} else {
					categorized = inspectInstance(instance);
				}

				var table = validateDocs(className, instance, helpDoc, categorized);
				elem.appendChild(table);

			}

			// Actively processes all help documents defined in list.js or loaded the processed results from storage
			function loadDocuments() {

				var json = window.localStorage[storageKey];
				if (!json) {

					var docParser = new HelpDocParser(hostFrame,  list.Reference, function(collected2) {
						window.localStorage[storageKey] = JSON.stringify(collected2);
						typesLoaded(collected2);
					});
					docParser.run();

				} else {

					typesLoaded(JSON.parse(json));

				}

			}

			// TODO: Rename to verb based definition of functionality
			function typesLoaded(collected) {

				var item,
					li;

				allTypes.innerHTML = '';

				for (var i = 0, length = collected.length; i < length; i++) {

					item = collected[i];

					li = document.createElement('li');
					li.innerHTML = item.helpClassName;
					li.setAttribute('data-url', item.helpUrl);
					allTypes.appendChild(li);
				}

				hostFrame.style.width = 'calc(100% - 430px)';
				hostFrame.onload = null;

				helpDocs = {};

				// Loop over all collected docs building out the helpDocs
				// object for indexed lookup as well as populating the members
				// property for the same reason
				collected.forEach(function (doc) {

					doc.members = {};

					// Build members prop
					[doc.Properties, doc.Methods].forEach(function (section) {

						if (section && section.length > 0) {

							for (var i = 0, length = section.length; i < length; i++) {
								var item = section[i];
								doc.members[item.name] = item;
							}
						}
					});

					// Assign doc
					helpDocs[doc.helpClassName] = doc;

				});

			}

		</script>

	</body>
</html>

