<!doctype html>
<html>
	<head>
		<title>Help Docs</title>
		<link href="style.css" rel="stylesheet" />
		<base href="/" />
	</head>
	<body>
		<script src="build/three.js"></script>

		<!-- TypeLoader dependencies -->
		<script src="examples/fonts/helvetiker_regular.typeface.js"></script>
		<script src="examples/js/loaders/ColladaLoader.js"></script>

		<script src="docs/list.js"></script>

		<script src="docs/viewer/HelpDocParser.js"></script>
		<script src="docs/viewer/TestHelpDocs.js"></script>
		<script src="docs/node_indexer/tokenmap.js"></script>

		<script id="dyn"></script>

		<div id="links" >

			<ul id="shots1" class="exampleView"></ul>

		</div>

		<iframe id="hostFrame" name="hostFrame" style="width: 100%; height: 600px;"></iframe>

		<div id="results">

			<div id="scripts">

				<img src="docs/viewer/js40.png" alt="Javascript" />

				<div></div>

			</div>

			<ul id="shots2" class="exampleView"></ul>


			<table></table>
		</div>

		<ul id="allTypes"></ul>

		<script>

			var storageKey = 'helpDocs';
			var types = [];
			var helpDocs = {};
			var errors = [];

			var el = {

				frame: document.getElementById('hostFrame'),
				results: document.getElementById('results'),
				shots1: document.getElementById('shots1'),
				shots2: document.getElementById('shots2'),
				scriptList: document.querySelector('#scripts div'),
				types: document.getElementById('allTypes')

			}

			el.types.addEventListener('click', showClickedItem, false);

			loadDocuments();

			function compareTypes(instance, base) {

				var local = [];
				var remote = [];
				var overridden = [];

				for (var p in instance)
				{
					var baseVal = base[p];
					var instVal = instance[p];

					var baseType = typeof baseVal;
					var instType = typeof instVal;

					if (p in base) {
						if (baseType == 'function' && !equals(instVal, baseVal, instType, baseType))
							overridden.push(p);
						else
							remote.push(p);
					} else {
						local.push(p)
					}
				}

				return { local: local, remote: remote, overridden: overridden };

			}

			function equals(dis, dat, typeA, typeB) {

				if (typeA != typeB) return false;

				switch (typeA) {
					case 'object':
						if (Array.isArray(dis)) {
							return JSON.stringify(dis) == JSON.stringify(dat);
						} else {
							return dis === dat; break;
						}
					case 'function':
						return dis.toString() == dat.toString(); break;
					default:
						return dis == dat; break;
				}
			}

			function emptyElement() {

				for (var p in arguments) {

					var elem = arguments[p];

					while (elem.lastChild)
						elem.removeChild(elem.lastChild);

				}

			}

			function showClickedItem(e) {

				// Display the help docs
				el.frame.src = 'docs/' + e.srcElement.getAttribute('data-url');

				var className = e.srcElement.textContent;
				var helpDoc = helpDocs[className];
				var categorized;

				function groupRelatedFilesByType(){

					var results = {
						examples: [],
						scripts: []
					};

					// The tokenMap optimizes for storage space (it's fairly big and serialized to localStorage) and
					// as such simply integer references to file paths rather than strings. To make use of the data,
					// we remap by looking up in the files array as done below
					var fileList = tokenMap.tokenMap['THREE.' + className].map(function(i){ return tokenMap.files[i]});

					for( var i = 0, length = fileList.length; i < length; i++ ) {

						var file = fileList[i];

						if (file.indexOf('.js') == -1) {

							results.examples.push(file);

						} else {

							results.scripts.push(file);

						}

					}

					return results;

				}

				var grouped = groupRelatedFilesByType();

				emptyElement(el.shots1, el.shots2, el.scriptList);

				showRelatedShots(el.shots1, el.shots2,  grouped.examples);
				showRelatedScripts(el.scriptList, grouped.scripts);

				try
				{
					var instance = typeMap.getInstance(className);

					if (helpDoc.superName || helpDoc.protoName) {
						// Compare the instance against its proto to decipher inheritance
						categorized = compareTypes(instance, typeMap.getInstance(helpDoc.superName || helpDoc.protoName))
					} else {
						categorized = inspectInstance(instance);
					}

					var table = validateDocs(className, instance, helpDoc, categorized);
					el.results.appendChild(table);

				}
				catch(e)
				{
					console.log('Unable to load type (' + className + '); ' + e);
				}

			}

			// Actively processes all help documents defined in list.js or loaded the processed results from storage
			function loadDocuments() {

				var json = window.localStorage[storageKey];
				if (!json) {

					var docParser = new HelpDocParser(el.frame,  list.Reference, function(collected2) {
						window.localStorage[storageKey] = JSON.stringify(collected2);
						typesLoaded(collected2);
					});
					docParser.run();

				} else {

					typesLoaded(JSON.parse(json));

				}

			}

			// TODO: Rename to verb based definition of functionality
			function typesLoaded(collected) {

				var item,
					li;

				allTypes.innerHTML = '';

				var debug = true;
				var loadErrors = [];

				collected.sort( function(a,b) {
					return a.className.localeCompare(b.className);
				});

				for (var i = 0, length = collected.length; i < length; i++) {

					item = collected[i];

					if(debug) {

						try {
							var instance = typeMap.getInstance(item.className);
						}
						catch(e) {
							errors.push({name: item.className, error: e});
						}

					}

					li = document.createElement('li');
					li.innerHTML = item.helpClassName;
					li.setAttribute('data-url', item.helpUrl);
					allTypes.appendChild(li);
				}

				el.frame.style.width = 'calc(100% - 430px)';
				el.frame.onload = null;

				helpDocs = {};

				// Loop over all collected docs building out the helpDocs
				// object for indexed lookup as well as populating the members
				// property for the same reason
				collected.forEach(function (doc) {

					doc.members = {};

					// Build members prop
					[doc.Properties, doc.Methods].forEach(function (section) {

						if (section && section.length > 0) {

							for (var i = 0, length = section.length; i < length; i++) {
								var item = section[i];
								doc.members[item.name] = item;
							}
						}
					});

					// Assign doc
					helpDocs[doc.helpClassName] = doc;

				});

			}

		</script>

	</body>
</html>

